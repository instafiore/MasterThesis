\chapter{Minimizing reason}
\label{cp:minimizing_reason}
In Section~\ref{sec:properties_reason},
we  discuss some important properties of a reason. Subsequently,
we introduce the concept of a \textit{redundant literal}
and explain the notion of \textit{increment},in section ~\ref{sec:redundant_literal} and ~\ref{sec:increment} respectively.
Utilizing these concepts,
we define two algorithms in sections ~\ref{subsec:minimal_reason},~\ref{subsec:cardinality_minimal_reason}: one for obtaining 
the minimal reason and the other for obtaining the cardinality minimal reason, respectively.
At the end (section ~\ref{sec:complexity}) the complexity of both algorithms is analized, showing that
the first algorithm has a \textit{polynomial} complexity and the second one has a \textit{pseudo-polynomial}
complexity.
In the last part ~\ref{subsubsection:hardness}, the second algorithm is proved to be \textit{NP-Hard}. 

All the discussion applies on the inference rule ~\eqref{eq:amosum:propagation:2} for a constraint $\sigma$ of the from ~\eqref{eq:amosum}, thus, when it is possible, the subscript 
${\sigma}$ is omitted .


\section{Properties of a reason}
\label{sec:properties_reason}
An important property of a reason $R$ is that $\Pi \models R$, i.e., 
it is redundant.
Let $R_1,R_2$ be two reason of $z$ of the form:
\begin{align}
    \label{eq:reasons_1}
    &R_1 = \{z\} \cup \{\ell_1, \hdots, \ell_n, y\} \\ 
    \label{eq:reasons_2}
    &R_2 = \{z\} \cup \{\ell_1, \hdots, \ell_n, \overline{y}\}, 
\end{align}
where $n \ge 0$.
In this case $R_1 \setminus \{y\} = R_2 \setminus \{\overline{y}\}$ and $z,y \in R_1$ and 
$z,\overline{y} \in R_2$.
Let $\Pi$ be a program such that $\Pi \models R_1$ and $\Pi \models R_2$.
Let $I \models \Pi$ then $I \models R_1$ and $I \models R_2$, hence $I \models R_1 \land R_2$.
We have seen in ~\ref{sec:bg-SM} that 
$R_1 \land R_2 \rightarrow R_1 \otimes_{y} R_2$, thus $I \models  R_1 \otimes_{\ell} R_2$,
hence $\Pi \models R_1 \otimes_{y} R_2 = \{z\} \cup \{\ell_1, \hdots, \ell_n\} = R$.
Since $z \in R$ and $\Pi \models R$ then $R$ is a reason of $z$ in $\Pi$.
\begin{example} continuing example ~\ref{ex:amosum:propagation:more-2}\\
    When $I = [\overline{y}, \overline{w}]$ then $z$ is inferred,
    thanks to \eqref{eq:amosum:propagation:2},with $\mathit{reason}(z) = \{z,y,w\} = R_1$.
    If $I = [y, \overline{w}]$ then $mps(I,z) = \mathit{wh}(y) = 2 < 3$ and 
    $lits\mid_{group(z)} \setminus \overline{I} = \{z\}$ so $z$ is inferred 
    with $\mathit{reason}(z) = \{z,\overline{y},w\} = R_2$.
    Since $R_1 = \{z\} \cup \{w,y\}$,
    $R_2 = \{z\} \cup \{w,\overline{y}\}$
    are two reason of the form ~\ref{eq:reasons_1},~\ref{eq:reasons_2} (respectively) then 
    $\Pi \models R_1 \otimes_{y} R_2 = \{z,w\} = R$ and $R$ is a reason of $z$.
\end{example}
We can see in the above example that $y$ can be removed from the reason, getting $R$,
and $R$ continues to be a reason, so it is \textit{redundant}.

\section{Redundant literal}
\label{sec:redundant_literal}
Let $L$ be set such that $\ell \in L$,
then $L_{\overline{\ell}} = (L \setminus \{\ell\}) \cup \{\overline{\ell}\}$.
A literal $\ell$ is \textit{redundant} in a reason $R$ of the literal $z$, under intepretation $I$, 
if $R_{\overline{\ell}}$ is a reason of $z$ under $I_{\ell}$.
If $\ell \in R$ then  $R,R_{\overline{\ell}}$ are of the form ~\ref{eq:reasons_1} and 
~\ref{eq:reasons_2} respectively,
and $R \otimes_{\ell} R_{\overline{\ell}} = R \setminus \{\ell\} = R'$ is a reason of $z$.
Note that $R'$ is a reason under  $I' = \overline{R' \setminus \{z\}}$; 
thus, given that $I' \subseteq I$, then $R'$ is a reason under $I$.
It is easy to see that every redundat literal of a reason $R$ can be removed from it.
\begin{example}{Continuing example ~\ref{ex:amosum:propagation:more-2}}\\
    \label{ex:redundant_lit}
    When $I = [\overline{y}, \overline{w}]$ then $z$ is inferred,
    thanks to \eqref{eq:amosum:propagation:2},with $\mathit{reason}(z) = \{z,y,w\} = R$;
    $R$ is a reason of $z$ under $I$.\\
    Let's check if $y$ is redundant.
    $R_{\overline{y}} = (R \setminus \{y\}) \cup \{\overline{y}\} = \{z,\overline{y},w\}$ and $I_{y} = [y,\overline{w}]$.
    With $J_{R_{\overline{y}}} = [y,\overline{w}]$ the propagator, thanks to \eqref{eq:amosum:propagation:2}, 
    would infer $z$.
    So, $R_{\overline{y}}$ is a reason for $z$
    and $y$ is redundant in $R$.
    Now, let's take the case where $I = [x, \overline{y}, \overline{w}]$, 
    and $z$ is inferred with $\mathit{reason}(z) = \{z, w, \overline{x}\} = R$, that is, 
    $\overline{w} \land  x \rightarrow z$.
    Let's check if $\overline{x}$ is redundant.\\
    $R_{x} = \{z, w, x\}$ and it is a reason of $z$ under $I_{\overline{x}}[\overline{w}, \overline{y},\overline{x}]$, 
    since $J_{R_x} = \overline{\{w, x\}} = [\overline{w},\overline{x}] \subseteq I_{\overline{x}}$
    infers $z$. Hence, $x$ is redundant in $R$.
\end{example}
Continuing the discussion about the example ~\ref{ex:redundant_lit}.
Let's examine the first case more in detail: $\mathit{reason}(z) = \{z, w, y\} = R $ is a 
reason of $z$ under $I = [\overline{y}, \overline{w}]$. This is true because,
given $J_R = \overline{\{z, w, y\} \setminus \{z\}} = \{\overline{w},\overline{y}\} $,
$mps(J_R,z) = \mathit{wh}(x) = 1 < 3$ and $lits\mid_{group(z)} \setminus \overline{I} = \{z\}$.
Since $R_{\overline{y}} = \{z, w, \overline{y}\}$ then $J_{R_{\overline{y}}} = [\overline{w},y]$ and 
$mps(J_{R_{\overline{y}}},z) = \mathit{wh}(y) = 2 < 3$ and
$lits\mid_{group(z)} \setminus \overline{I_y} = \{z\}$, thus $z$ would be added in $I_y$.
More in concrete, $y$ is redundant because $mps(J_R,z) + \mathit{inc}(y) = 1 + 1 < \mathit{bnd} = 3$ and
$y \not\in group(z)$, where the $\mathit{inc}(y) = \max\{mps(J_{R_{\overline{y}}},z) - mps(J_R,z),0\} = \max\{2 - 1,0\} = 1$.
Now, let's take the other case, where $I = [x, \overline{y}, \overline{w}]$, 
and $z$ is inferred with $\mathit{reason}(z) = \{z, w, \overline{x}\}$, that is, 
$\overline{w} \land  x \rightarrow z$.
As already seen $J_{R_{x}}=[\overline{x}, \overline{w}]$.\\
$mps(J_{R_{x}},z) = \mathit{wh}(y) = 2 < 3$ and
$lits\mid_{group(z)} \setminus \overline{I_{\overline{x}}} = \{z\}$, 
so $\mathit{reason}(z)=\{z, x, w\}$
and $\overline{x}$ is redundant.

\section{Increment}
\label{sec:increment}

The increment of $\ell$, \textit{w.r.t.} a reason $R$, written $\mathit{inc}(\ell)$, is used to check 
if $\ell$ is redundant in $R$.
Given a reason $R$ of a literal $z$, the increment of a literal $\ell \in R$ is computed as:
$$\mathit{inc}(\ell) = \max\{mps(J_{R_{\overline{\ell}}},z) - mps(J_R,z),0\}$$

There is no need to have an increment possibly negative, given that if $\inc(\ell) \le 0$
then by assumption $\mps(J_R,z) + \inc(\ell) < \mathit{bnd}$.
The increment is bounded below by 0 for another important reason: 
when a literal \(\ell\) is found to be redundant in \(R\), it will be removed from \(R\).

If \(\mathit{inc}(\ell) = \mathit{mps}(J_{R_{\overline{\ell}}}, z) - \mps(J_R,z)\) were not bounded, 
then \(\mathit{mps}(J_R, z) + \mathit{inc}(\ell)\) would represent the \textit{mps} where \(\ell\) is flipped.
However, the new \textit{mps} needs to represent the value when \(\ell\) is removed.
To see this, consider that when a literal is removed from \(R\), the new reason \(R'\) 
will have an interpretation where \(\ell\) is undefined. Thus, by construction, the \textit{mps}
will be equal to the maximum value reached when \(\ell\) is false or true.
If $\mathit{mps}(J_{R_{\overline{\ell}}}, z) < \mps(J_R,z)$
then the `previous' $\mps$ is the greatest, that is, the increment of it is $0$.
This property of the increment is important for the following algorithms (~\ref{subsec:minimal_reason},
~\ref{subsec:cardinality_minimal_reason}) that try
to remove literals from \(R\).

\subsection{False literal}
Let $\ell$ be a \textit{false} literal that is,
$\overline{\ell} \in I$. 
A reason $R$ of a literal $z$ under $I$ can contain $\ell$, let's assume $R$ to be 
such reason.
Let $J_R = \overline{R \setminus \{z\}}$, 
$J_{R_{\overline{\ell}}} = \overline{R_{\overline{\ell}} \setminus \{z\}}$, thus
$\ell \in J_{R_{\overline{\ell}}}$.\\
Note that $mps(J_R,z) = \sum_{g \in \mathbb{G} \setminus
\{\mathit{group}(z)\}}{\mathit{mwh}(J_R,g)}$ and \\
$mps(J_{R_{\overline{\ell}}},z) = \sum_{g \in \mathbb{G} \setminus
\{\mathit{group}(z) \cup \group(\ell)\}}
{\mathit{mwh}(J_{R_{\overline{\ell}}},g) + \wh(\ell)}$;
given that $\ell$ will be true and thanks to AMO inference rule it will 
contribute to the $\mps$.
Hence: $$\mathit{mps}(J_{R_{\overline{\ell}}},z)-\mathit{mps}(J_R,z) = 
\wh(\ell) - \mathit{mwh}(J_R,\mathit{group}(\ell))$$ and 
$$ \inc(\ell) = \max\{\wh(\ell) - \mathit{mwh}(J_R,\mathit{group}(\ell)),0\}$$
Hence, when a literal has to be checked to be redundant and it is false then 
$\inc(\ell)$ has to be considered has the increment of the $\mps$.

\subsection{True literal}
Let $\ell$ be a \textit{true} literal that is,
$\ell \in I$. 
A reason $R$ of a literal $z$ under $I$ can contain $\overline{\ell}$, let's assume $R$ to be 
such reason.
Then  $J_R = \overline{R \setminus \{z\}}$ and $J_{R_{\ell}} = \overline{R_{\ell} \setminus \{z\}}$, thus
$\overline{\ell} \in J_{R_{\ell}}$.\\ 
Since $\ell \in I$ then $R$, by construction, does not containt any literal of $group(\ell)$ 
except $\ell$, then $R_{\ell}$ will do the same.
Since $J_{R_{\ell}} = \overline{R_{\ell} \setminus \{z\}}$ then also $J_{R_{\ell}}$ 
has no literal of group of $\ell$
except $\overline{\ell}$ (since it is false, it does not contribute to the $\mps$).
That is, $\mathit{mwh}(J_{R_{\ell}},group(\ell))= \max\{ \mathit{mwh}(x) \mid \mathit{group}(x) = group(\ell) \} 
= \mathit{mwh}(group(\ell))$.
It is easy to see that
$$\mathit{mps}(J_{R_{\ell}},z)-\mathit{mps}(J_R,z) = \mathit{mwh}(group(\ell)) - \mathit{wh}(\ell)$$
By construction $\mathit{mwh}(group(\ell)) - \mathit{wh}(\ell) \ge 0$, then:
$$\inc(\ell) = \max\{\mathit{mwh}(group(\ell)) - \mathit{wh}(\ell),0\} = \mathit{mwh}(group(\ell)) - \mathit{wh}(\ell)$$
Hence, when a literal has to be checked to be redundant and it is true then 
$\inc(\ell)$ has to be considered has the increment of the $\mps$.

\subsection{Algorithm}
In this section, the algorithm computing the increment is proposed. By construction,
the function \(\mathit{inc}(\ell) \geq 0\) for all \(\ell \in R \setminus \lits|_{\group(z)}\), since removing 
a literal from a reason in the worst case does not affect the \textit{mps}.

% \begin{theorem}
%     \label{theorem:inc}
%     Given a reason $R$ and a literal $\ell \in R$ then $\inc(\ell) \ge 0$.
% \end{theorem}

% \begin{proof}
%     Case when $I \models \ell \in R$.
%     Then $\inc(\ell) = \mwh(\group(\ell))-\mathit{wh}(\ell)$. Since $\mwh(\group(\ell))$ is the  
%     maximum weight in $\lits \mid_{\group(\ell)}$ and $\ell \in \lits \mid_{\group(\ell)}$ then 
%     $\mwh(\group(\ell)) \ge \mathit{wh}(\ell)$ and $\inc(\ell) \ge 0$.

%     Case when $I \models \overline{\ell} \in R$.
%     For readability let define $g = \group(\ell)$.\\
%     Then $\inc(\ell) = \mathit{mwh}(J_{R_{\overline{\ell}}},g) - \mathit{mwh}(J_R,g).$\\
%     Since $J_{R_{\overline{\ell}}} = (J_R \setminus \{\overline{\ell}\}) \cup \{\ell\}$ then 
%     $$\mathit{mwh}(J_{R_{\overline{\ell}}},g) = 
%     \max\{w \cdot J_R^{\neg\bot}(\ell) \mid (w : \ell\ [g]) \in \sigma\} \cup \{\wh(\ell)\}$$
%     It is trivial to see that 
%     $$\max\{w \cdot J_R^{\neg\bot}(\ell) \mid (w : \ell\ [g]) \in \sigma\} \cup \{\wh(\ell)\}
%     \ge \max\{w \cdot J_R^{\neg\bot}(\ell) \mid (w : \ell\ [g]) \in \sigma\}$$
%     Since $\max\{w \cdot J_R^{\neg\bot}(\ell) \mid (w : \ell\ [g]) \in \sigma\} = \mwh(J_R,g)$
%     then $$\max\{w \cdot J_R^{\neg\bot}(\ell) \mid (w : \ell\ [g]) \in \sigma\} \cup \{\wh(\ell)\}
%     \ge \mwh(J_R, g).$$
%     Given that  $\max\{w \cdot J_R^{\neg\bot}(\ell) \mid (w : \ell\ [g]) \in \sigma\} \cup \{\wh(\ell)\} = 
%     \mathit{mwh}(J_{R_{\overline{\ell}}},g)$, finally, 
%     $$\mathit{mwh}(J_{R_{\overline{\ell}}},g) \ge \mwh(J_R, g)$$

%     In both cases $\inc(\ell) \ge 0$.\\ Hence, $\inc(\ell) \ge 0$ for all $\ell \in R$
% \end{proof}

The following algorithm computes the increment as previously described.
\begin{algorithm}[h]\small
    \caption{inc}
        \label{alg:increment}
        \SetKwInOut{Input}{Input}
        \Input{literal $\ell \in R$, interpretation $I$, reason $R$}.
        \SetKwBlock{Loop}{Loop}{end}
        \Begin{
            \If {$I \models \ell$}{
                \Return{ $\mathit{mwh}(group(\ell)) - \mathit{wh}(\ell)$}
            }\Else{
                $J_R = \overline{R \setminus \{z\}}$ \\
                \Return{$\max\{\wh(\ell) - \mathit{mwh}(J_R,\mathit{group}(\ell)),0\}$}
            }
        }
\end{algorithm}

Given a reason $R$, intepretation $I$ and a set $S \subseteq R$
the \textit{total increment of S} denoted $\inc(S,I,R) = \sum_{\ell \in S} \inc(\ell, I, (R \setminus S)\cup \{\ell\})$ 

\section{Minimality}
\label{sec:minimality}
In this section we  propose two algorithms to minimize the reason 
generated by the propagator. The first algorithm  (~\ref{subsec:minimal_reason}) is an algorithm
to get the minimal reason.
In subsection ~\ref{subsec:cardinality_minimal_reason}, instead,
a new algorithm to compute the cardinality minimal reason is proposed.
For both algorithms a proof of correcntess is provided.

\subsection{Minimal reason}
\label{subsec:minimal_reason}

Given a reason $R$ of a literal $\ell$ then it is minimal if there  not exists 
a literal $\ell' \in R$ such that $R \setminus \{\ell'\}$ is a reason of 
$\ell$. In other words, $R$ is minimal if it does not containts redundant literals.
As seen before with each literal $\ell$ in a reason $R$ has an \textit{increment}.
That is, the increment to the mps when  $\ell$ is removed from the reason.

At this point, an important parallel must be drawn: 
minimizing a reason \(R\) equates to maximizing the
number of literals removed from \(R\). 
This first algorithm identifies the \textit{maximal} 
set of literals to be removed from \(R\).

\paragraph{Maximal Subset Sum}
As mentioned before finding the minimal reason is 
equal to find the maximal set of literal to remove from the reason.
Let $R$ be a reason of a literal $z$ under interpretation $I$ and
$S \subseteq R'$ be a set of literals where $R' = R\setminus\lits|_{\group(z)}$.
$S$ can be removed from $R$ if 
$$\sum_{e \in S}\inc(e,I,(R'\setminus S) \cup \{e\}) \le s $$
where $s = \mathit{bnd} - \mps(I,z) - 1$.
To comprehend the reasoning behind $s$, it is crucial to observe that, 
given $J = B(R'\setminus S)$ 
then $$\mps(J,z) = \mps(I,z) + \sum_{e \in S}\inc(e,I,(R'\setminus S) \cup \{e\})$$
For $R'\setminus S$ to remain a reason
the condition $\mps(R'\setminus S,z) \le \mathit{bnd} - 1$
must continue to hold.
Since $\mps(I,z) \le \mathit{bnd} - 1 $ (otherwise $R$ would not be a reason)
and $\sum_{e \in S}\inc(e,I,(R'\setminus S) \cup \{e\}) \le \mathit{bnd} - \mps(I,z) - 1$
then $$\mps(I,z) + 
\sum_{e \in S}\inc(e,I,(R'\setminus S) \cup \{e\}) \le \mps(I,z) + 
\mathit{bnd} - \mps(I,z) - 1 = \mathit{bnd} - 1$$.
Now, the entire algorithm can be defined. 
It begins with an empty set $S$ and a current increment $ci$
equal to 0. For each literal $\ell$ that is not in the group 
of $z$ it verifies if $\ell$ is \textit{redundant}.
If it is, it is added to the set $S$ and the $ci$
increase of $\inc(\ell)$. 
\begin{algorithm}[h]\small
    \caption{Maximal Subset sum (MSS)}
    \label{alg:maximal_subset}
    \SetKwInOut{Input}{Input}
    \SetKwInOut{Parameters}{Paramenters}
    \SetKwInOut{Output}{Output}
    \Input{intepretation $I$, reason $R$ of $z$, threshold $s$}
    \Parameters{\textit{inc} function}
    \Output{subset maximal}
    \Begin{
        $\mathit{S} \gets [\,]$ \\
        $\mathit{ci} \gets 0$ \\
        \For{$\ell \in R \setminus \lits|_{\group(z)}$}{
            \If{$\mathit{ci} + \inc(\ell,I,R \setminus \mathit{S}) \leq s$}{
                $\mathit{ci} \gets$ $ci + \inc(\ell,I,R\setminus \mathit{S})$ \\
                $\mathit{S} \gets \mathit{S} \cup \{\ell\} $\\
            }
        }
        \Return{\textit{S}}
    }
\end{algorithm}

\subparagraph{Proof Correctness}

Before proving the theorem about the correcntess of algorithm ~\ref{alg:maximal_subset}
the following lemma has to be proved.

\begin{lemma}
    \label{lemma:maximal_subset}
    Given a reason $R$, a set $S \subseteq R$, a literal $\ell \in R \setminus S$
    and $\mathit{ci},s \in \mathbb{N}$.
    If $\mathit{ci} +  \inc(\ell,I,R \setminus \mathit{S}) > s$
    then every superset  $S' \supseteq S \cup \{\ell\}$ yields to 
    an increment greater of $s$
\end{lemma}

\begin{proof}
    The total increment of $S' = \inc(S',I,R) = \inc(S,I,R) + \inc(\ell,I,R \setminus \mathit{S}) + 
    \sum_{\ell \in S'} \inc(x, I, R \setminus S' \cup \{x\})$.
    By assumption $\inc(S,I,R) + \inc(\ell,I,R \setminus \mathit{S}) > s$  and  by construction $\inc(x, I, R \setminus S' \cup \{x\}) \ge 0$ then 
    $\inc(S',I,R) > s$.
    Hence, $S'$ is not a subset of $R$ giving as sum a value less than $s$.

\end{proof}

\begin{theorem}
    The Maximal Subset Sum algorithm returns the maximal subset $S$ where $\inc(S,I,R) \le s$
\end{theorem}

\begin{proof}
    Let $S_m$ the final subset returned by \textit{MSS}.
    Arguing by contradiction, if it is not maximal 
    it means that there is a literal $\ell \in R \setminus S_m$ that could be
    added to $S_m$.
    But since $\mathit{ci} +  \inc(\ell,I,R \setminus \mathit{S}) \ge s$
    for some $S$.
    Since $S \subseteq S_m$, then $S \cup \{\ell\} \subseteq S_m \cup \{\ell\}$;
    thanks to theorem ~\ref{lemma:maximal_subset} $S_m \cup \{\ell\}$
    is not a subset giving as sum a value less then $s$, that is, $\ell$ cannot be 
    added to $S_m$.
    Hence, $S_m$ is maximal.
\end{proof}


\subsection{Cardinality Minimal Reason}
\label{subsec:cardinality_minimal_reason}

This section, as previously mentioned, we propose a new algorithm to minimize the reason,
the main difference is that with algorithm ~\ref{alg:maximal_subset} the final reason 
is not guaranteed to be cardinality-minimal.
This new approach can find a cardinality-minimal reason, at the price of 
having a \textit{pseuso-polynomial} algorithm.
Before introducing the algorithm some preliminars have to be done.

\paragraph*{Preliminars} All the previous notation continue to hold.
Let $I$ an interpretation, $R$ be a reason of $z$ generated under $I$ 
and $S \subseteq R$ a set of redundant literals of $R$.\\
Function $\mathit{\ml_\inc} : \mathcal{P}(R) \times \mathit{G} \mapsto R$ 
returns the \textit{maximum increment literal in S of group g};
that is, 
$\ml_\inc(S,g)= \arg\max_{k \in S \cap \lits|_{{\group(g)}}} \inc(k,I,(R \setminus S) \cup \{k\} )$.\\   
Given a set , a literal $\ell$ is active in $S$ if $\ml_\inc(S,\group(\ell)) = \ell$;
the set of active literal of $S$ is equal to $A_S = \{\ell \in S \mid \ell \text{ is active in S}\}$.
Given a literal $l \in R$ then $blw: R \mapsto \mathcal{P}(R)$ is a function 
that returns all the literals \textit{below} $\ell$, 
that is, $\blw(\ell) = \{ k \in \lits|_{\group(\ell)} \mid \inc(k,I,R) \le \inc(l,I,R) \}$.
Function $\mathit{sum}(S) = \sum_{\ell \in A_S} \inc(\ell,I,R)$ is the sum of all increments  
of active literals of $S$.\\
A extension of a set $S$ with a literal $\ell \in R \setminus S$, written as $S' = S \ext \ell$,
is equal to $S' = S \cup blw(\ell)$.\\
A sufficient condition for a literal $\ell$ 
to be active in $S' = S \ext \ell$ is that 
$S \cap \group(\ell) = \emptyset$.
Let $(\lits\_\mathit{ord}_g, \preceq)$ be an ordered set where $\lits\_\mathit{ord}_g = \lits|_g$
and $\preceq = \{(l,l') \in \lits|_g \times \lits|_g \,:\, \inc(l,I,R) \ge \inc(l',I,R)\}$.\\
Let 
\begin{align}
    \label{eq:L}
    L = \{l^1_1,\hdots,l^1_{m_1},\hdots,l^g_1,\hdots,l^g_{m_g},\hdots,l^k_1,\hdots,l^k_{m_k} \}
\end{align}
where $k = |\G|$, $m_g$ is the size of $lits\_\mathit{ord}|_g$ , $l^g_j$ is the j-th literal in $\lits\_\mathit{ord}_{g}$.
The set $L_j$ represent the first $j$ elements of $L$ and $n = |L|$.
Abusing of notation, given a literal $\ell_j \in L$, \{$\ell_j\} = L_j \setminus L_{j-1}$, i.e., $\ell_j$
is the \textit{j-th} literal in $L$.
% Let $M$ be a matrix where each cell is a subset of $L$ or it is equal to $\Box$.
% $M_{i,j} \subseteq L$  is named \textit{correct} 
% if it is the cardinality-maximal set with $sum(M_{i,j}) = i$ and $M_{i,j} \subseteq L_j$.
% If $M_{i,j} = \Box$ then it means that there are no subset of $L$ such that the total increment 
% is less or equal to $s$.

\paragraph{Cardinality-Maximal Set}
As done in section ~\ref{subsec:minimal_reason} to find a minimal reason $R'$ starting 
from $R$ we compute a maximal subset $S$ of $R$ of redudant literals to remove from $R$.
In the first approach, the cardinal-minimality property is not ensured, instead 
in this case $S$ is \textit{cardinality-maximal}.
Differently from the ~\ref{alg:maximal_subset}, here the increment is \textbf{always}
with respect the \textit{`initial'} increment, that is, with respect to the initial reason $R$;
instead in the first algorithm the increment dependes from the \textit{current} reason.
  
\begin{algorithm}[H]\small
\caption{Cardinality Maximum Subset Sum (CMSS)}
    \label{alg:CMSS}
    \SetKwInOut{Input}{Input} 
    \SetKwInOut{Parameters}{Parameters}
    \SetKwInOut{Output}{Output}
    \SetKwBlock{Loop}{Loop}{end}
    \Input{L, intepretation $I$, reason $R$ of $z$, threshold $s$}
    \Parameters{\(group : \text{Group Function}\), \(inc : \text{Increment Function}\)}
    \Output{$S$: Set of literals representing the maximum subset}
    \Begin{
        $n \gets |L|$\\
        $M \gets \mathit{Init}(I,R,L,s)$\\
        \For{\(i \in  \{ 1, \hdots, s\}\) }{
            \For{\(j \in  \{ 1, \hdots, n\}\) }{
                \(\ell \leftarrow \ell_{j - 1}\)\\
                \(w \leftarrow inc(\ell,I,R)\)\\
                \If{\(i \geq w\)}{
                    $k = \arg \max_{k \in \{0,\hdots,j-1\}} \ell_j \not\in M_{i-w,k}$\\
                    $M_{i,j} \leftarrow \arg \max \{|M_{i - w,k} \ext \ell|, |M_{i,j - 1}| \}$
                }\Else{
                    \(M_{i,j} \leftarrow M_{i,j-1}\)\\
                }
            }
        }
        $S = \arg\max_{i \in \{0, \hdots, s\}} |M_{i,n}|$ \\
        \Return{$S$}
    }
\end{algorithm}

\begin{algorithm}[H]\small
    \caption{Init}
        \label{alg:init}
        \SetKwInOut{Input}{Input}
        \Input{interpretation $I$, reason $R$, $L$, threshold $s \in \mathbb{N}$}.
        \SetKwBlock{Loop}{Loop}{end}
        \Begin{
            $M_{0,j} = \{ \ell \mid \ell \in L_j \land inc(\ell,I,R) = 0\} \quad \forall j \in \{1, \hdots , |L|\}$\\
            $M_{i,0} = \Box \quad \forall i \in \{1, \hdots , s\}$\\
        }
\end{algorithm}

The algorithm ~\ref{alg:CMSS} computes the cardinality-maximal subset $S$ of $L$ such that 
the total increment $\inc(S,I,R) \le s$, using a \textit{dynamic} approach.
It creates a matrix $M$ where each cell $M_{i,j}$ has domain $\mathcal{P}(L) \cup \{\Box\}$.
$M_{i,j}$ represents the cardinality-maximal set with $sum(M_{i,j}) = i$ and $M_{i,j}$ \textit{`considers'} 
literal in $L_j$; considers means that \textbf{just} literals in $L_j$ can be active, all the literals 
in $L \setminus L_j$ can appear in $M_{i,j}$ but are \textbf{not} active. 
If a set $S$ is built considering just literals in $D \subseteq L$ then 
it is written: $S \sqsubseteq D$.
If $M_{i,j} = \Box$ it means that such set does not exists.
When $M_{i,j} = \Box$ then, abusing of notation, $|M_{i,j}| = -1$,
$M_{i,j} \ext \ell = \Box$ and $\ell \not\in M_{i,j}$ for all $\ell \in L$.
The matrix is initialized with function \textit{Init} ~\ref{alg:init}.
This function will initialize just the first row and column.
It is trivial to see that $M_{0,j}$ will contain all the literals of $L_j$ 
with increment equal to 0, since the sum $i = 0$.
Thus, the first row will be 
$M_{0,j} = \{ \ell \mid \ell \in L_j \land inc(\ell,I,R) = 0\} \quad \forall j \in \{1, \hdots , n\}$.

When the sum $ i > 0$ then with $L_0 = \emptyset$ is impossible to reach $i$, 
that's why $M_{i,0} = \Box \quad \forall i \in \{1, \hdots , s\}$.
After initilization the algorithm ~\ref{alg:CMSS} constructs each cell $M_{i,j}$
, with $ 1 \le i \le s$ and $1 \le j \le n$, starting from $M_{i,j-1}$ and $M_{i-w,k}$,
where $w = \inc(\ell_j,I,R)$ and $k = \arg \max_{k \in \{0,\hdots,j-1\}} \ell_j \not\in M_{i-w,k}$.
Let $S_{\overline{\ell}} \sqsubseteq L_j $ and $S_{\ell} \sqsubseteq L_j$ and having 
a total increment equal to $i$, with \(\ell_j\) 
non-active and \(\ell_j\) active, respectively. 
By selecting the larger set between these two, 
we obtain the maximum set considering literals in $L_j$.
$S_{\overline{\ell}} = M_{i,j-1}$, since is the largest set giving as sum $i$
and $\ell$ is not active given that $M_{i,j-1}$ considers just the first $j-1$ literals;
note, this does not mean that $M_{i,j-1} \cap \{\ell\} = \emptyset$, since can happen 
that for some $d < j$ $M_{i,d} = M_{l,k} \ext \ell_d$ and $\group(\ell_d) = \group(\ell_j)$.
Instead finding $S_{\ell}$ is not so trivial, we cannot just take $M_{i-w,j-1}$,
since $M_{i-w,j-1}$ could containt a literal $\ell_d$ such that $d < j$,
$\group(\ell_d) = \group(\ell_j)$ and in that case 
$\mathit{sum}(M_{i-w,j-1}) = \mathit{sum}(M_{i-w,j-1} \ext \ell_j)$;
it is due to the fact that $\ell_j$ would not be active.
Since $L$ is ordered, and within each group there is a descending order, and since each 
cell $M_{i,j}$ is computed from left to right
then $M_{i-w,j-1} \cap \lits_{\group(\ell)} = \emptyset$ is also a \textit{necessary}
condition to have $\ell$
active in $M_{i-w,j-1} \ext \ell$
(so it becomes necessary and sufficient).
Since, by construction, $M_{i-w,j-1}$ can contain just literals \textit{`greater'} (in terms of 
increment) of $\ell_j$, and if this happens also $\ell_j$ is inside $M_{i-w,j-1}$ then 
it is sufficient to check that $M_{i-w,j-1} \cap \{\ell_j\} = \emptyset$.
Taking $M_{i-w,k} \ext \ell_j$ with $k = \arg \max_{k \in \{0,\hdots,j-1\}} \ell_j \not\in M_{i-w,k}$ 
yields the cardinality maximum set with a sum of \( i \), and \(\ell_j\) active.
Hence, $S_{\ell} = M_{i-w,k}$.
Subsequently, after the for loop is completed all cells of the matrix are correct 
and it is enough to take the largest set in the last column, that is, the 
largest set giving as sum a value less or equal to $s$ considering all literals in $L$.

This informal discussion has outlined the reasoning behind the algorithm. 
The following section will provide a formal proof of the concepts discussed.
so far.

\subparagraph{Proof Correcntess}
To formally prove that algorithm ~\ref{alg:CMSS} is correct, a lemma 
has to be proved.
\begin{lemma}
    Given a set of literals $D \subseteq L$, a literal $\ell \in D$ and a set $S_{\overline{\ell}} \sqsubseteq D$
    and $S_{\ell} \sqsubseteq D$ and a sum $s$.
    Let $S_{\overline{\ell}}$ is the maximum cardinality set giving $s$ as sum with $\ell$ being an \textit{non-active} literal
    and $S_{\ell}$ is the maximum cardinality set with $\ell$ being an \textit{active literal} giving $s$  as sum.\\
    Let $ S = \arg\max_{X \in \{S_{\ell}, S_{\overline{\ell}}\}} |X| $. \\ 
    Then $S \subseteq D$ is a maximum cardinality set that gives as sum $s$.
    \label{lemma:cmin}
\end{lemma}

\begin{proof}
    Let's assume by contradiction that $S$ is not the maximum cardinality set that gives as sum $s$.
    So there exists a set $S' \sqsubseteq D$ such that $|S'| > |S|$.
    If $\ell \not\in A_{S'}$ then $|S'| > |S_{\overline{\ell}}|$, that is $S_{\overline{\ell}}$ 
    is not the maximum cardinality set 
    with $\ell$ being a \textit{non-active literal} giving as sum $s$, but this is a contradiction.
    So $\ell \in A_{S'}$ then $|S'| > |S_{\ell}|$, that is $S_{\ell}$ is not the maximum cardinality set 
    with $\ell$ being a \textit{active literal} giving as sum $s$, but this is a contradiction.
    So $\ell \in A_{S'}$ and $ \ell \not\in A_{S'}$ and this is a contradiction.
\end{proof}



To prove that algorithm \textit{CMSS} ~\ref{alg:CMSS} returns the cardinality maximal subset $S$ 
where  $\inc(S,I,R) \le s$ it is necessary to introduce the
relation $C_M \subseteq N_1 \times N_2$, where $N_1 = \{-\mathit{max}_\inc, \hdots, -1, 0, \hdots, s\}$,
$N_2 = \{0, \hdots, n\}$ and $\mathit{max}_\inc = \max \{ \inc(\ell,I,R) \mid \ell \in L\}$.
The relation $C_M$ is defined as follows:
\begin{align*}
    C_M = \{ (i,j) \in N_1 \times N_2 \mid i \in \{-\mathit{max}_\inc, \hdots, -1\}\} \quad  \cup \\
    \{(i,j) \in N_1 \times N_2 \mid M_{i,j} \text{ is largest set s.t. } M_{i,j} \sqsubseteq L_j \text{ and } 
    \mathit{sum}(M_{i,j}) = i\}
\end{align*}
% \mathit{sum}(M_{i,j}) = i \text{ and } M_{i,j} \subseteq L_j
$C_M$ represents the notion of \textit{`correct'}: $(i,j) \in C_M$ \textit{iff}
$M_{i,j}$ is actually the maximum set, considering literals in $L_j$,
giving as sum a value equal to $i$ for all $i \in \{0, \hdots, s\}$
and $j \in \{0, \hdots, n\}$.
The first block $\{ (i,j) \in N_1 \times N_2 \mid i \in \{-\mathit{max}_\inc, \hdots, -1\}\}$
has a \textit{`padding'} purpose, i.e., if the sum is less than 0 it cannot be reached ( since function $\inc$
has been proved to be bounded by 0 below), so it is true by default (this is usefull for the following
theorem).

\begin{theorem}
    \label{thereom:inductive:cmin}
    $C_M(i,j)$ holds for all $i \in \{0, \hdots, s\}$
    and $j \in \{0, \hdots, n\}$
\end{theorem}

\begin{proof}(Induction proof)\\
   This proof is a two variable induction proof.\\
   \textit{Base case(s)}:
   \begin{itemize}
        \item $C_M(i,j)$ hold $\forall i \in \{-\mathit{max}_\inc, \hdots, -1\}$ and $\forall j \in \{0, \hdots, n\}$ 
        \item $C_M(0,j)$ holds $\forall j \in \{0, \hdots, n\}$ 
        \item $C_M(i,0)$ holds $\forall i \in \{1, \hdots, s\}$
   \end{itemize}
   \textit{Induction hypothesis}:
   \begin{itemize}
        \item if $C_M(i,j-1)$ and $C_M(i-w,k)$ hold then $C_M(i,j)$ holds $\forall i \in \{1,\hdots,s\}$
        and $\forall j \in \{1, \hdots, n\}$.
        \\ Where $w = \inc(\ell_j,I,R)$ and $k = \arg \max_{k \in \{0,\hdots,j-1\}} \ell_j \not\in M_{i-w,k}$.
   \end{itemize}
   It is easy to see that, if the base cases  and the induction are proved then 
   every $C_M(i,j)$ is \textit{`inferred '} from previous cells $(i,j-1)$ and $(i-w,k)$ 
   $\forall i \in \{1,\hdots,s\}$ and $\forall j \in \{1, \hdots, n\}$;
   it would mean that $C_M(i,j)$ holds $\forall i \in \{0,\hdots,s\}$ and $\forall j \in \{0, \hdots, n\}$.\\
   \textit{Proof base cases}
   \begin{itemize}
    \item $C_M(i,j)$ hold $\forall i \in \{-\mathit{max}_\inc, \hdots, -1\}$ and $\forall j \in \{0, \hdots, n\}$ 
    \begin{itemize}
        \item It is true since \textit{by construction} $(i,j) \in C_M$ if $i \in \{-\mathit{max}_\inc, \hdots, -1\}$.
    \end{itemize}
    \item $C_M(0,j)$ holds $\forall j \in \{0, \hdots, n\}$ 
    \begin{itemize}
        \item \textit{By construction}, $(0,j) \in C_M$ \textit{iff}
        $M_{i,j} \text{ is the maximum subset on } L_j \text{ giving as sum } 0$.
        Algorithm \textit{CMSS} ~\eqref{alg:CMSS} builds 
        $$M_{0,j} = \{ \ell \mid \ell \in L_j \land inc(\ell,I,R) = 0\} \quad \forall j \in \{1, \hdots , |L|\}$$
        Then $M_{0,j} \subseteq L_j$ and
        $M_{i,j} \text{ is the maximum subset s.t. } \inc(M_{i,j},I,R) = 0$,
        given that to get the maximum set it is enough to add all literals with increment 0.
        Hence, $(0,j) \in C_M \quad \forall j \in \{0, \hdots, n\}$ 

    \end{itemize}
    \item $C_M(i,0)$ holds $\forall i \in \{1, \hdots, s\}$
    \begin{itemize}
        \item Algorithm \textit{CMSS} builds 
        $$M_{i,0} = \Box \quad \forall i \in \{1, \hdots , s\}$$
        It is trivial to see that, if $i > 0$ and $j = 0$ then it is impossible 
        to reach sum $i$ with $0$ elements, so such subset does not exists.
        Thus, $M_{i,0}$ \textit{`represent'} the maximum subset.
        Hence, $(i,0) \in C_M \quad \forall i \in \{1, \hdots, s\}$ 
    \end{itemize}
   \end{itemize}
   Now, let's move to the induction hypothesis.
   \begin{itemize}
    \item If $C_M(i,j-1)$ and $C_M(i-w,k)$ hold then $C_M(i,j)$ holds $\forall i \in \{1,\hdots,s\}$
    and $\forall j \in \{1, \hdots, n\}$.
    \\ Where $w = \inc(\ell_j,I,R)$.
    \begin{itemize}
        \item If $C_M(i,j-1)$ holds then \textit{by definition} $M_{i,j-1}$ is the largest set 
            such that $M_{i,j-1} \sqsubseteq L_{j-1}$ and $\mathit{sum}(M_{i,j-1}) = i$.
            Let $S_{\overline{\ell_j}} \sqsubseteq L_j$ be the largest set with sum $i$
            and $\ell_j$ is \textbf{non-active}.
            Now the claim to get is that $M_{i,j-1} = S_{\overline{\ell_j}}$.
            Since $l_j$ has to be not active, $S_{\overline{\ell_j}}$ has to be built considering $L_j \setminus \{\ell_j\}$,
            i.e., $S_{\overline{\ell_j}} \sqsubseteq L_{j-1}$.
            All Possible Set to be considered are $PS = \{S \mid S \sqsubseteq L_{j-1} \text{ and } \inc(S,I,R) = i\}$.
            Given that, \textit{by induction hypothesis}, $C_M(i,j-1)$ holds, then $|M_{i,j-1}| \ge |S| \quad \forall S \in PS$.
            So, given that $S_{\overline{\ell_j}}$ is the largest set amoung those in $PS$ then 
            $|M_{i,j-1}| =|S_{\overline{\ell_j}}|$.
            Thus, we can take $M_{i,j-1}$ as $S_{\overline{\ell_j}}$.\\

            If $C_M(i-w,k)$ holds then \textit{by definition} $M_{i-w,k}$ is the largest set 
            such that $M_{i,k} \sqsubseteq L_{k}$ and $\mathit{sum}(M_{i,k}) = i-w$, where 
            $w = \inc(\ell_j,I,R)$ and $k = \arg \max_{k \in \{0,\hdots,j-1\}} \ell_j \not\in M_{i-w,k}$.
            Let $S_{\ell_j} \sqsubseteq L_j$ be the largest set with sum $i$
            and $\ell_j$ is \textbf{active}.
            Let $M_{i,k} \ext \ell_j = E_{\ell_j}$ be the set obtained after \textit{extending} 
            $M_{i,k}$ with $\ell_j$.
            Let's analize what is the value of $\mathit{sum}(E_{\ell_j})$.
            By \textit{definition} $\mathit{sum}(M_{i-w,k}) = i-w$.
            By \textit{construction}  $\mathit{sum}(M_{i-w,k}) \cap \lits|_{\group(\ell)} = \emptyset$;
            as seen in the preliminars it is a sufficient condition to deduce that $\ell_j$ is active 
            in $M_{i,k} \ext \ell_j$, that is, $\ell_j \in A_{E_{\ell_j}}$.
            Thus, since $\mathit{sum}(M_{i-w,k}) = i-w$ and $\ell_j \not\in M_{i,k}$ and $ \ell \in A_{E_{\ell_j}}$ then 
            $\mathit{sum}(M_{i,k} \ext \ell_j,I,R) = \mathit{sum}(E_{\ell_j}) = \mathit{sum}(M_{i-w,k}) + \inc(\ell_j,I,R) = i - w + w = i$.
            Now the claim to get is that $E_{\ell_l} = S_{\ell_j}$.
            This claim is reached reasoning by contradition.
            Let's assume that $E_{\ell_l}$ is not the largest set, in other words: 
            there exists a set $S' \sqsubseteq L_j$ such that $|S'| > |E_{\ell_j}|$, moreover,
            $\mathit{sum}(S') = i$ and $\ell_j \in A_{S'}$ (i.e., $\ell_j$ is active).
            In this case $\ell_j \in A_{E_{\ell_j}} \cap A_{S'}$, i.e., it is active in both sets;
            so by construction $\blw(\ell_j) \subseteq E_{\ell_j}$ and $\blw(\ell_j) \subseteq S'$, furthermore,
            there not exists a literal $\ell' \in \lits|_{\group(\ell_j)}$ such that $\wh(\ell') > \wh(\ell_j)$
            and $\ell' \in E_{\ell_j}$ or $\ell' \in S'$, thus,
            $|S' \setminus \blw(\ell_j)| > |E_{\ell_j} \setminus \blw(\ell_j)|$.
            Given that $E_{\ell_j} = M_{i-w,k} \ext \ell_j = M_{i-w,k} \cup blw(\ell_j,j)$ then
            $E_{\ell_j} \setminus blw(\ell_j) = (M_{i-w,k} \cup blw(\ell_j)) \setminus blw(\ell_j) = M_{i-w,k}.$
            Given that $\ell_j \in A_{S'}$ it means that $S' \cap \group(\ell_j) \setminus \blw(\ell_j) = \emptyset$, i.e.,
            there is no literal $\ell' \in S'$ such that $\wh(\ell') > \ell_j$.
            So, $S'' = S' \setminus \blw(\ell_j) \sqsubseteq L_d$ where $d \in \{0,\hdots,j-1\}$
            such that $L_d \cap \group(\ell_j) = \emptyset$.
            Given that $\ell_j$ is active in $S'$ then $\mathit{sum}(S'') = \mathit{sum}(S') - \inc(\ell_j,I,R) = i - w$.
            Since $|S'' \sqsubseteq L_d| > |M_{i-w,k}| \sqsubseteq L_k $ it means that
            $d > k$, since to be greater than $M_{i-w,k}$ then $S''$ 
            has to consider more literals then $L_k$ (otherwise $M_{i-w,k}$ would not be the largest set considering $L_k$).
            So $d > k = \arg \max_{k \in \{0,\hdots,j-1\}} \ell_j \not\in M_{i-w,k}$.
            So $k < d \le j-1$, it means that $L_d$ contains some literal of the group of $\ell_j$,
            and it is a contradiction.
            Thus, $E_{\ell_l}$ is the largest set such that $E_{\ell_l} \sqsubseteq L_j$ and $\ell_j \in A_{E_{\ell_j}}$.
            Hence, we can take $S_{\ell_j} = E_{\ell_j}$.
            By lemma ~\ref{lemma:cmin}, given that $S_{\overline{\ell_j}}$ is the maximum cardinality set giving $i$ as sum with $\ell_j$ 
            being an \textit{non-active} literal
            and $S_{\ell_j}$ is the maximum cardinality set with $\ell_j$ being an \textit{active literal} giving $i$  as sum.\\
            Then $S = \arg\max_{X \in \{S_{\ell}, S_{\overline{\ell}}\}} |X|$  is a maximum cardinality set that gives as sum $s$.
            Given that $M_{i,j} = S$ then $C_M(i,j)$ holds, and the prove is completed.
    \end{itemize}
   \end{itemize}
\end{proof}

Now the theorem proving the correctness is straightforward.
\begin{theorem}
    \label{theorem:cardinality:maximal}
    The Cardinality Maximal Subset Sum algorithm returns the cardinality maximal subset $S$ where its sum 
    of increments of $S$ is less than $s$
\end{theorem}

\begin{proof}
    Thanks theorem ~\ref{thereom:inductive:cmin} $C_M(i,j)$ holds for all $i \in \{0, \hdots, s\}$
    and $j \in \{0, \hdots, n\}$.
    Thus, $M_{i,n}$ is the largest set considering $L_n = L$ literals with sum $i$.
    Given that $i \in \{0, \hdots, s\}$, taking the largest set in the last column $n$ leads to the maximum set with sum less or equal 
    to $s$.
\end{proof}

\section{Complexity}
\label{sec:complexity}
\subsection{Minimal Reason}
\subsubsection{Polynomial}
\subsection{Cardinality Minimal Reason}
\subsubsection{Pseudo-Polynomial}
\subsubsection{NP-Hardness}
\label{subsubsection:hardness}

To prove that problem to find a \textit{Cardinality Maximum Subset Sum (CMSS)}
is \textit{NP-Hard} we define a reduction from the well-know NP-Hard problem 
\textit{0/1 Knapsack Problem} to \textit{CMR}.\\
\textbf{\textit{Problem Definitions}}\\
\textit{0/1 Knapsack Problem:}\\
Input:
    \begin{itemize}
        \item A set $K=\{(v_1,w_1),\hdots,(v_n,w_n)\}$ of \( n \) of 
        items defined by pairs, each item with weight \( w_i \) and value \( v_i \), for \( i = 1, \ldots, n \).
        \item A knapsack with a maximum weight capacity \( W \).
    \end{itemize}
Output:
    \begin{itemize}
        \item A subset of items that maximizes the total value while keeping the total weight within \( W \).
    \end{itemize}
\textit{Cardinality Maximum Subset Sum:}\\
Input:
    \begin{itemize}
        \item A reason $R$ of a literal $z$ under interpretation $I$.
        \item A threshold $s$.
    \end{itemize}
Output:
    \begin{itemize}
        \item A subset of items that maximizes the total value while keeping the total weight within \( W \).
    \end{itemize}
\textbf{\textit{Reduction from 0/1 Knapsack Problem to CMSS}}



